# Phlo Infrastructure Stack
# Generated by: phlo services init
# Dev mode: true
# Modify .env to customize configuration

services:
  minio:
    image: minio/minio:RELEASE.2025-09-07T16-13-09Z
    restart: unless-stopped
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minio}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minio123}
    ports:
    - ${MINIO_API_PORT:-9000}:9000
    - ${MINIO_CONSOLE_PORT:-9001}:9001
    volumes:
    - ./volumes/minio:/data
    command:
    - server
    - /data
    - --console-address
    - :9001
    healthcheck:
      test:
      - CMD
      - curl
      - -f
      - http://localhost:9000/minio/health/ready
      interval: 10s
      timeout: 5s
      retries: 10
  postgres:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-phlo}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-phlo}
      POSTGRES_DB: ${POSTGRES_DB:-phlo}
    ports:
    - ${POSTGRES_PORT:-5432}:5432
    volumes:
    - ./volumes/postgres:/var/lib/postgresql/data
    healthcheck:
      test:
      - CMD-SHELL
      - pg_isready -U ${POSTGRES_USER:-phlo}
      interval: 10s
      timeout: 5s
      retries: 10
  minio-setup:
    image: minio/mc:latest
    restart: 'no'
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minio}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minio123}
    entrypoint: '/bin/sh -c " sleep 5 && mc alias set myminio http://minio:9000 $${MINIO_ROOT_USER}
      $${MINIO_ROOT_PASSWORD} && mc mb --ignore-existing myminio/lake && mc mb --ignore-existing
      myminio/lake/warehouse && mc mb --ignore-existing myminio/lake/stage && echo
      ''Buckets created successfully'' "

      '
    depends_on:
      minio:
        condition: service_healthy
  nessie:
    image: ghcr.io/projectnessie/nessie:${NESSIE_VERSION:-0.106.0}
    restart: unless-stopped
    environment:
      NESSIE_VERSION_STORE_TYPE: JDBC
      QUARKUS_DATASOURCE_JDBC_URL: jdbc:postgresql://postgres:5432/${POSTGRES_DB:-phlo}
      QUARKUS_DATASOURCE_USERNAME: ${POSTGRES_USER:-phlo}
      QUARKUS_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-phlo}
      nessie.catalog.default-warehouse: warehouse
      nessie.catalog.warehouses.warehouse.location: s3://lake/warehouse
      nessie.catalog.service.s3.default-options.endpoint: http://minio:9000/
      nessie.catalog.service.s3.default-options.path-style-access: 'true'
      nessie.catalog.service.s3.default-options.region: us-east-1
      nessie.catalog.service.s3.default-options.access-key: urn:nessie-secret:quarkus:nessie.catalog.secrets.access-key
      nessie.catalog.secrets.access-key.name: ${MINIO_ROOT_USER:-minio}
      nessie.catalog.secrets.access-key.secret: ${MINIO_ROOT_PASSWORD:-minio123}
    ports:
    - ${NESSIE_PORT:-19120}:19120
    healthcheck:
      test:
      - CMD
      - curl
      - -f
      - http://localhost:19120/api/v1/config
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    depends_on:
      postgres:
        condition: service_healthy
      minio:
        condition: service_healthy
  trino:
    image: trinodb/trino:${TRINO_VERSION:-467}
    restart: unless-stopped
    environment:
      AWS_ACCESS_KEY_ID: ${MINIO_ROOT_USER:-minio}
      AWS_SECRET_ACCESS_KEY: ${MINIO_ROOT_PASSWORD:-minio123}
      AWS_REGION: us-east-1
      S3_ENDPOINT: http://minio:9000
      S3_PATH_STYLE_ACCESS: 'true'
    ports:
    - ${TRINO_PORT:-8080}:8080
    volumes:
    - ./trino/catalog:/etc/trino/catalog:ro
    healthcheck:
      test:
      - CMD
      - curl
      - -f
      - http://localhost:8080/v1/info
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 45s
    depends_on:
      nessie:
        condition: service_healthy
      minio:
        condition: service_healthy
  dagster:
    build:
      context: .
      dockerfile: dagster/Dockerfile
      args:
        PHLO_VERSION: ${PHLO_VERSION:-}
    restart: unless-stopped
    environment:
      DAGSTER_HOME: /opt/dagster
      PYTHONPATH: /opt/dagster:/app
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minio}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minio123}
      AWS_ACCESS_KEY_ID: ${MINIO_ROOT_USER:-minio}
      AWS_SECRET_ACCESS_KEY: ${MINIO_ROOT_PASSWORD:-minio123}
      AWS_REGION: us-east-1
      AWS_S3_ENDPOINT: http://minio:9000
      AWS_S3_USE_SSL: 'false'
      AWS_S3_URL_STYLE: path
      NESSIE_HOST: nessie
      NESSIE_PORT: 19120
      TRINO_HOST: trino
      TRINO_PORT: 8080
      TRINO_CATALOG: iceberg
      ICEBERG_WAREHOUSE_PATH: s3://lake/warehouse
      ICEBERG_STAGING_PATH: s3://lake/stage
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: ${POSTGRES_USER:-phlo}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-phlo}
      POSTGRES_DB: ${POSTGRES_DB:-phlo}
      WORKFLOWS_PATH: /app/workflows
      DBT_PROJECT_DIR: /app/transforms/dbt
      SUPERSET_ADMIN_PASSWORD: ${SUPERSET_ADMIN_PASSWORD:-admin}
      PHLO_HOST_PLATFORM: ${PHLO_HOST_PLATFORM:-}
      PHLO_DEV_MODE: 'true'
    ports:
    - ${DAGSTER_PORT:-3000}:3000
    volumes:
    - ./dagster:/opt/dagster
    - ../workflows:/app/workflows:ro
    - ../transforms:/app/transforms
    - ../tests:/app/tests:ro
    - ../../../phlo/src/phlo/../..:/opt/phlo-dev:rw
    env_file:
    - ../.env
    command:
    - dagster-webserver
    - -h
    - 0.0.0.0
    - -p
    - '3000'
    - -w
    - /opt/dagster/workspace.yaml
    depends_on:
      postgres:
        condition: service_healthy
      minio:
        condition: service_healthy
      nessie:
        condition: service_healthy
      trino:
        condition: service_healthy
  dagster-daemon:
    build:
      context: .
      dockerfile: dagster/Dockerfile
      args:
        PHLO_VERSION: ${PHLO_VERSION:-}
    restart: unless-stopped
    environment:
      DAGSTER_HOME: /opt/dagster
      PYTHONPATH: /opt/dagster:/app
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minio}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minio123}
      AWS_ACCESS_KEY_ID: ${MINIO_ROOT_USER:-minio}
      AWS_SECRET_ACCESS_KEY: ${MINIO_ROOT_PASSWORD:-minio123}
      AWS_REGION: us-east-1
      AWS_S3_ENDPOINT: http://minio:9000
      AWS_S3_USE_SSL: 'false'
      AWS_S3_URL_STYLE: path
      NESSIE_HOST: nessie
      NESSIE_PORT: 19120
      TRINO_HOST: trino
      TRINO_PORT: 8080
      TRINO_CATALOG: iceberg
      ICEBERG_WAREHOUSE_PATH: s3://lake/warehouse
      ICEBERG_STAGING_PATH: s3://lake/stage
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: ${POSTGRES_USER:-phlo}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-phlo}
      POSTGRES_DB: ${POSTGRES_DB:-phlo}
      WORKFLOWS_PATH: /app/workflows
      DBT_PROJECT_DIR: /app/transforms/dbt
      SUPERSET_ADMIN_PASSWORD: ${SUPERSET_ADMIN_PASSWORD:-admin}
      PHLO_HOST_PLATFORM: ${PHLO_HOST_PLATFORM:-}
      PHLO_DEV_MODE: 'true'
    volumes:
    - ./dagster:/opt/dagster
    - ../workflows:/app/workflows:ro
    - ../transforms:/app/transforms
    - ../tests:/app/tests:ro
    - ../../../phlo/src/phlo/../..:/opt/phlo-dev:rw
    env_file:
    - ../.env
    command:
    - dagster-daemon
    - run
    - -w
    - /opt/dagster/workspace.yaml
    depends_on:
      dagster:
        condition: service_started
