# Phlo Infrastructure Stack
# Generated by: phlo services init
# Dev mode: true
# Modify .env to customize configuration

services:
  phlo-api:
    restart: unless-stopped
    environment:
      HOST: 0.0.0.0
      PORT: 4000
      PYTHONUNBUFFERED: "1"
      PHLO_DEV_MODE: "true"
    ports:
      - ${PHLO_API_PORT:-4000}:4000
    build:
      context: ../../../src/phlo/core_services/phlo-api
      dockerfile: Dockerfile
    healthcheck:
      test:
        - CMD
        - curl
        - -f
        - http://127.0.0.1:4000/health
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
  hello-world:
    image: hashicorp/http-echo
    restart: unless-stopped
    ports:
      - 5678:5678
    command:
      - -text
      - Hello from a custom inline service!
  observatory:
    restart: unless-stopped
    environment:
      NODE_ENV: development
      HOST: 0.0.0.0
      PORT: 3000
      DAGSTER_GRAPHQL_URL: http://dagster:3000/graphql
      NESSIE_URL: http://nessie:19120/api/v2
      TRINO_URL: http://trino:8080
      PHLO_API_URL: http://phlo-api:4000
      CUSTOM_VAR: Hello from phlo.yaml!
    ports:
      - 9000:3000
    build:
      context: ../../../packages/phlo-observatory/src/phlo_observatory
      dockerfile: Dockerfile
    command:
      - npm
      - run
      - dev
      - --
      - --host
      - 0.0.0.0
      - --port
      - "3000"
    volumes:
      - ../../../packages/phlo-observatory/src/phlo_observatory:/app
      - /app/node_modules
    healthcheck:
      test:
        - CMD
        - wget
        - --no-verbose
        - --tries=1
        - --spider
        - http://127.0.0.1:3000/
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    depends_on:
      phlo-api:
        condition: service_healthy
